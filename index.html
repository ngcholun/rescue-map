<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rescue Cabin Map</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .map {
      display: grid;
      grid-template-columns: repeat(7, 80px);
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .cabin {
      width: 80px;
      height: 80px;
      background: #ccc;
      border: 2px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      text-align: center;
    }
    .form-container {
      margin-top: 30px;
      display: none;
      text-align: center;
    }
    label, select, textarea {
      display: block;
      margin: 10px auto;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Rescue Cabin Map</h1>
  <div class="map" id="map"></div>

  <div class="form-container" id="formContainer">
    <h2 id="formTitle">Cabin</h2>
    <form id="cabinForm">
      <label for="status">Status</label>
      <select id="status">
        <option value="">-- choose --</option>
        <option value="safe">Safe</option>
        <option value="needsHelp">Needs Help</option>
        <option value="rescued">Rescued</option>
      </select>

      <label for="notes">Notes</label>
      <textarea id="notes"></textarea>

      <button type="submit">Save Status</button>
    </form>
  </div>

  <!-- ‚úÖ Firebase compat SDKs (v8 style APIs) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /***********************************************************
     * üîë Firebase Configuration
     ***********************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBShQZMBHu1dNGw81tvI3t5IVQtNOYVbR4",
      authDomain: "rescue-map-cb629.firebaseapp.com",
      databaseURL: "https://rescue-map-cb629-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rescue-map-cb629",
      storageBucket: "rescue-map-cb629.firebasestorage.app",
      messagingSenderId: "1047215320171",
      appId: "1:1047215320171:web:ec96b70002c55bb94a552e",
      measurementId: "G-8BY9K2T845"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /***********************************************************
     * Map + Form Setup
     ***********************************************************/
    const map = document.getElementById("map");
    const formContainer = document.getElementById("formContainer");
    const formTitle = document.getElementById("formTitle");
    const cabinForm = document.getElementById("cabinForm");
    const statusInput = document.getElementById("status");
    const notesInput = document.getElementById("notes");

    const cabins = [];
    let currentCabin = null;

    // Build 84 cabins (7 √ó 12 grid)
    for (let i = 1; i <= 84; i++) {
      const div = document.createElement("div");
      div.className = "cabin";
      div.id = "CABIN_" + i;
      div.textContent = "Cabin " + i;
      div.onclick = () => openForm(div);
      map.appendChild(div);

      const cabinObj = { id: div.id, el: div, fields: { status: "", notes: "" } };
      cabins.push(cabinObj);

      /***********************************************************
       * ‚úÖ Realtime listener placed inside the loop
       ***********************************************************/
      db.ref("cabins/" + div.id).on("value", snapshot => {
        if (snapshot.exists()) {
          cabinObj.fields = snapshot.val();
          updateCabinColor(cabinObj);

          if (currentCabin && currentCabin.id === cabinObj.id) {
            statusInput.value = cabinObj.fields.status || "";
            notesInput.value = cabinObj.fields.notes || "";
          }
        }
      });
    }

    /***********************************************************
     * Form Handling
     ***********************************************************/
    function openForm(cabinDiv) {
      currentCabin = cabins.find(c => c.id === cabinDiv.id);
      if (!currentCabin) return;
      formTitle.textContent = currentCabin.id;
      statusInput.value = currentCabin.fields.status || "";
      notesInput.value = currentCabin.fields.notes || "";
      formContainer.style.display = "block";
    }

    cabinForm.onsubmit = function(e) {
      e.preventDefault();
      if (!currentCabin) return;

      currentCabin.fields.status = statusInput.value;
      currentCabin.fields.notes = notesInput.value;

      db.ref("cabins/" + currentCabin.id)
        .set(currentCabin.fields)
        .then(() => console.log("‚úÖ Saved to Firebase"))
        .catch(err => console.error("‚ùå Firebase error:", err));

      updateCabinColor(currentCabin);
      formContainer.style.display = "none";
    };

    /***********************************************************
     * Cabin Color Logic
     ***********************************************************/
    function updateCabinColor(cabin) {
      switch (cabin.fields.status) {
        case "safe": cabin.el.style.background = "lightgreen"; break;
        case "needsHelp": cabin.el.style.background = "orange"; break;
        case "rescued": cabin.el.style.background = "lightblue"; break;
        default: cabin.el.style.background = "#ccc"; break;
      }
    }
  </script>
</body>
</html>